<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<title> Knowledge </title>
<!-- js includes at the top as post embedded js colliding -->
<script src="/static/legacy/knowledge-repo/modules/jquery/jquery.min.js"></script>
<script src="/static/legacy/knowledge-repo/modules/tether/js/tether.min.js"></script>
<script src="/static/legacy/knowledge-repo/modules/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/legacy/knowledge-repo/modules/bootstrap-slider/js/bootstrap-slider.min.js"></script>
<script src="/static/legacy/knowledge-repo/modules/typeahead.js/typeahead.bundle.min.js"></script>
<script src="/static/legacy/knowledge-repo/modules/handlebars/js/handlebars.js"></script>
<script src="/static/legacy/knowledge-repo/js/helpers.js"></script>
<script src="/static/legacy/knowledge-repo/modules/select2/js/select2.min.js"></script>
<script src="/static/legacy/knowledge-repo/modules/hightlight.pack.js/highlight.pack.js"></script>
<script src="/static/legacy/knowledge-repo/modules/marked.js/marked.js"></script>
<!-- require js is used for plotly, but has a bunch of collisions with other js packages
             make sure to have it be last js package imported -->
<script src="/static/legacy/knowledge-repo/modules/require.js/require.min.js"></script>
<!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/2.1.0/es5-shim.min.js"></script>
        <![endif]-->
<link href="/static/legacy/knowledge-repo/modules/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
<link href="/static/legacy/knowledge-repo/modules/bootstrap-slider/css/bootstrap-slider.min.css" rel="stylesheet"/>
<link href="/static/legacy/knowledge-repo/css/custom.css" rel="stylesheet" type="text/css"/>
<link href="/static/legacy/knowledge-repo/modules/select2/css/select2.min.css" rel="stylesheet" type="text/css"/>
<link href="https://fonts.googleapis.com/css?family=Lato:400,900|Playfair+Display|Source+Serif+Pro:400,700" rel="stylesheet" type="text/css"/>
<link href="/static/legacy/knowledge-repo/images/favicon.png" rel="shortcut icon"/>
<link href="/static/legacy/knowledge-repo/css/codehilite-friendly.css" rel="stylesheet"/>
<style>
            .spinner {
                position: fixed;
                top: 50%;
                left: 50%;
                margin-left: -50px; /* half width of the spinner gif */
                margin-top: -50px; /* half height of the spinner gif */
                text-align:center;
                z-index:1234;
                overflow: auto;
                width: 100px; /* width of the spinner gif */
                height: 102px; /*hight of the spinner gif +2px to fix IE8 issue */
            }

            .table {
              font-size: 14px;
            }

            .modal-content {
              max-width: 1024px;
            }

             

          </style>
</head>
<body>

<div class="container page-container">
<br/>
<div class="container-fluid">
<div class="row">
<div class="col-md-6">

</div>
<div class="col-md-2">
</div>

</div>
<div class="row col-md-12">
</div>
</div>
<div class="container-fluid">
<div class="row">
<div class="col-md-12">
<div id="renderedMarkdown">
<div class="metadata">
<h1>Firefox Application Update Out Of Date dashboard</h1>
<span class="authors"><a href="/feed?authors=rstrong">rstrong</a></span>
<span class="date_created">February 16, 2017</span>
<span class="date_updated">(Last Updated: November 22, 2018)</span>
<span class="tldr"><p>Creates the JSON data files used by the Firefox Application Update Out Of Date dashboard.</p></span>

</div>
<h3 id="motivation">Motivation</h3>
<p>Generate data for the Firefox Application Update Out Of Date dashboard</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span> <span class="kn">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">ujson</span> <span class="kn">as</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">boto3.s3.transfer</span> <span class="kn">import</span> <span class="n">S3Transfer</span>

<span class="o">%</span><span class="n">pylab</span> <span class="n">inline</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">defaultParallelism</span>
</pre></div>
<p>Get the time when this job started.</p>
<div class="codehilite"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="k">print</span> <span class="s2">"Start: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S"</span><span class="p">))</span>
</pre></div>
<p>Common settings.</p>
<div class="codehilite"><pre><span></span><span class="n">no_upload</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">today_str</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># Uncomment out the following two lines and adjust |today_str| as necessary to run manually without uploading the json.</span>
<span class="n">no_upload</span> <span class="o">=</span> <span class="bp">True</span>
<span class="c1"># today_str = "20161226"</span>

<span class="n">channel_to_process</span> <span class="o">=</span> <span class="s2">"release"</span>
<span class="n">min_version</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">up_to_date_releases</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">weeks_of_subsession_data</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">min_update_ping_count</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">min_subsession_hours</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">min_subsession_seconds</span> <span class="o">=</span> <span class="n">min_subsession_hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
</pre></div>
<p>Get the settings based on dates.</p>
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="n">today_str</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">today_str</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>

<span class="k">assert</span> <span class="p">(</span><span class="n">today_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">),</span> <span class="s2">"The date environment parameter is missing."</span>
<span class="n">today</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">today_str</span><span class="p">,</span> <span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

<span class="c1"># MON = 0, SAT = 5, SUN = 6 -&gt; SUN = 0, MON = 1, SAT = 6</span>
<span class="n">day_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">today</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
<span class="c1"># Filename used to save the report's JSON</span>
<span class="n">report_filename</span> <span class="o">=</span> <span class="p">(</span><span class="n">today</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">day_index</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
<span class="c1"># Maximum report date which is the previous Saturday</span>
<span class="n">max_report_date</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">day_index</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span>
<span class="c1"># Suffix of the longitudinal datasource name to use</span>
<span class="n">longitudinal_suffix</span> <span class="o">=</span> <span class="n">max_report_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
<span class="c1"># String used in the SQL queries to limit records to the maximum report date.</span>
<span class="c1"># Since the queries use less than this is the day after the previous Saturday.</span>
<span class="n">max_report_date_sql</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_report_date</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
<span class="c1"># The Sunday prior to the last Saturday</span>
<span class="n">min_report_date</span> <span class="o">=</span> <span class="n">max_report_date</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="c1"># String used in the SQL queries to limit records to the minimum report date</span>
<span class="c1"># Since the queries use greater than this is six days prior to the previous Saturday.</span>
<span class="n">min_report_date_sql</span> <span class="o">=</span> <span class="n">min_report_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
<span class="c1"># Date used to limit records to the number of weeks specified by</span>
<span class="c1"># weeks_of_subsession_data prior to the maximum report date</span>
<span class="n">min_subsession_date</span> <span class="o">=</span> <span class="n">max_report_date</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="n">weeks_of_subsession_data</span><span class="p">)</span>
<span class="c1"># Date used to compute the latest version from firefox_history_major_releases.json</span>
<span class="n">latest_ver_date_str</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_report_date</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>

<span class="k">print</span> <span class="s2">"max_report_date     : "</span> <span class="o">+</span> <span class="n">max_report_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
<span class="k">print</span> <span class="s2">"max_report_date_sql : "</span> <span class="o">+</span> <span class="n">max_report_date_sql</span>
<span class="k">print</span> <span class="s2">"min_report_date     : "</span> <span class="o">+</span> <span class="n">min_report_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
<span class="k">print</span> <span class="s2">"min_report_date_sql : "</span> <span class="o">+</span> <span class="n">min_report_date_sql</span>
<span class="k">print</span> <span class="s2">"min_subsession_date : "</span> <span class="o">+</span> <span class="n">min_subsession_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
<span class="k">print</span> <span class="s2">"report_filename     : "</span> <span class="o">+</span> <span class="n">report_filename</span>
<span class="k">print</span> <span class="s2">"latest_ver_date_str : "</span> <span class="o">+</span> <span class="n">latest_ver_date_str</span>
</pre></div>
<p>Get the latest Firefox version available based on the date.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">latest_version_on_date</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">major_releases</span><span class="p">):</span>
    <span class="n">latest_date</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">"1900-01-01"</span>
    <span class="n">latest_ver</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">version</span><span class="p">,</span> <span class="n">release_date</span> <span class="ow">in</span> <span class="n">major_releases</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">version_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">release_date</span> <span class="o">&lt;=</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">release_date</span> <span class="o">&gt;=</span> <span class="n">latest_date</span> <span class="ow">and</span> <span class="n">version_int</span> <span class="o">&gt;=</span> <span class="n">latest_ver</span><span class="p">:</span>
            <span class="n">latest_date</span> <span class="o">=</span> <span class="n">release_date</span>
            <span class="n">latest_ver</span> <span class="o">=</span> <span class="n">version_int</span>

    <span class="k">return</span> <span class="n">latest_ver</span>

<span class="n">major_releases_json</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s2">"https://product-details.mozilla.org/1.0/firefox_history_major_releases.json"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">major_releases</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">major_releases_json</span><span class="p">)</span>
<span class="n">latest_version</span> <span class="o">=</span> <span class="n">latest_version_on_date</span><span class="p">(</span><span class="n">latest_ver_date_str</span><span class="p">,</span> <span class="n">major_releases</span><span class="p">)</span>
<span class="n">earliest_up_to_date_version</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">latest_version</span> <span class="o">-</span> <span class="n">up_to_date_releases</span><span class="p">)</span>

<span class="k">print</span> <span class="s2">"Latest Version: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">latest_version</span><span class="p">)</span>
</pre></div>
<p>Create a dictionary to store the general settings that will be written to a JSON file.</p>
<div class="codehilite"><pre><span></span><span class="n">report_details_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"latestVersion"</span><span class="p">:</span> <span class="n">latest_version</span><span class="p">,</span>
                       <span class="s2">"upToDateReleases"</span><span class="p">:</span> <span class="n">up_to_date_releases</span><span class="p">,</span>
                       <span class="s2">"minReportDate"</span><span class="p">:</span> <span class="n">min_report_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">),</span>
                       <span class="s2">"maxReportDate"</span><span class="p">:</span> <span class="n">max_report_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">),</span>
                       <span class="s2">"weeksOfSubsessionData"</span><span class="p">:</span> <span class="n">weeks_of_subsession_data</span><span class="p">,</span>
                       <span class="s2">"minSubsessionDate"</span><span class="p">:</span> <span class="n">min_subsession_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">),</span>
                       <span class="s2">"minSubsessionHours"</span><span class="p">:</span> <span class="n">min_subsession_hours</span><span class="p">,</span>
                       <span class="s2">"minSubsessionSeconds"</span><span class="p">:</span> <span class="n">min_subsession_seconds</span><span class="p">,</span>
                       <span class="s2">"minUpdatePingCount"</span><span class="p">:</span> <span class="n">min_update_ping_count</span><span class="p">}</span>
<span class="n">report_details_dict</span>
</pre></div>
<p>Create the common SQL FROM clause.</p>
<div class="codehilite"><pre><span></span><span class="c1"># Note: using the parquet is as fast as using 'FROM longitudinal_vYYYMMDD'</span>
<span class="c1"># and it allows the query to go further back in time.</span>

<span class="c1">#longitudinal_from_sql = ("FROM longitudinal_v{} ").format(longitudinal_suffix)</span>
<span class="n">longitudinal_from_sql</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"FROM parquet.`s3://telemetry-parquet/longitudinal/v{}` "</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">longitudinal_suffix</span><span class="p">)</span>  
<span class="n">longitudinal_from_sql</span>
</pre></div>
<p>Create the common build.version SQL WHERE clause.</p>
<div class="codehilite"><pre><span></span><span class="n">build_version_where_sql</span> <span class="o">=</span> <span class="s2">"(build.version[0] RLIKE '^[0-9]{2,3}\.0[\.0-9]*$' OR build.version[0] = '50.1.0')"</span>
<span class="n">build_version_where_sql</span>
</pre></div>
<p>Create the remaining common SQL WHERE clause.</p>
<div class="codehilite"><pre><span></span><span class="n">common_where_sql</span> <span class="o">=</span> <span class="p">(</span><span class="s2">""</span>
    <span class="s2">"build.application_name[0] = 'Firefox' AND "</span>
    <span class="s2">"DATEDIFF(SUBSTR(subsession_start_date[0], 0, 10), '{}') &gt;= 0 AND "</span>
    <span class="s2">"DATEDIFF(SUBSTR(subsession_start_date[0], 0, 10), '{}') &lt; 0 AND "</span>
    <span class="s2">"settings.update.channel[0] = '{}'"</span>
<span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_report_date_sql</span><span class="p">,</span>
           <span class="n">max_report_date_sql</span><span class="p">,</span>
           <span class="n">channel_to_process</span><span class="p">)</span>
<span class="n">common_where_sql</span>
</pre></div>
<p>Create the SQL for the summary query.</p>
<div class="codehilite"><pre><span></span><span class="n">summary_sql</span> <span class="o">=</span> <span class="p">(</span><span class="s2">""</span>
<span class="s2">"SELECT "</span>
    <span class="s2">"COUNT(CASE WHEN build.version[0] &gt;= '{}.' AND build.version[0] &lt; '{}.' THEN 1 END) AS versionUpToDate, "</span>
    <span class="s2">"COUNT(CASE WHEN build.version[0] &lt; '{}.' AND build.version[0] &gt;= '{}.' THEN 1 END) AS versionOutOfDate, "</span>
    <span class="s2">"COUNT(CASE WHEN build.version[0] &lt; '{}.' THEN 1 END) AS versionTooLow, "</span>
    <span class="s2">"COUNT(CASE WHEN build.version[0] &gt; '{}.' THEN 1 END) AS versionTooHigh, "</span>
    <span class="s2">"COUNT(CASE WHEN NOT build.version[0] &gt; '0' THEN 1 END) AS versionMissing "</span>
<span class="s2">"{} "</span>
<span class="s2">"WHERE "</span>
    <span class="s2">"{} AND "</span>
    <span class="s2">"{}"</span>
<span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">latest_version</span> <span class="o">-</span> <span class="n">up_to_date_releases</span><span class="p">),</span>
           <span class="nb">str</span><span class="p">(</span><span class="n">latest_version</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
           <span class="nb">str</span><span class="p">(</span><span class="n">latest_version</span> <span class="o">-</span> <span class="n">up_to_date_releases</span><span class="p">),</span>
           <span class="nb">str</span><span class="p">(</span><span class="n">min_version</span><span class="p">),</span>
           <span class="nb">str</span><span class="p">(</span><span class="n">min_version</span><span class="p">),</span>
           <span class="nb">str</span><span class="p">(</span><span class="n">latest_version</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
           <span class="n">longitudinal_from_sql</span><span class="p">,</span>
           <span class="n">common_where_sql</span><span class="p">,</span>
           <span class="n">build_version_where_sql</span><span class="p">)</span>
<span class="n">summary_sql</span>
</pre></div>
<p>Run the summary SQL query.</p>
<div class="codehilite"><pre><span></span><span class="n">summaryDF</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">summary_sql</span><span class="p">)</span>
</pre></div>
<p>Create a dictionary to store the results from the summary query that will be written to a JSON file.</p>
<div class="codehilite"><pre><span></span><span class="n">summary_dict</span> <span class="o">=</span> <span class="n">summaryDF</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">asDict</span><span class="p">()</span>
<span class="n">summary_dict</span>
</pre></div>
<p>Create the SQL for the out of date details query.</p>
<div class="codehilite"><pre><span></span><span class="c1"># Only query for the columns and the records that are used to optimize</span>
<span class="c1"># for speed. Adding update_state_code_partial_stage and</span>
<span class="c1"># update_state_code_complete_stage increased the time it takes this</span>
<span class="c1"># notebook to run by 50 seconds when using 4 clusters.</span>

<span class="c1"># Creating a temporary table of the data after the filters have been</span>
<span class="c1"># applied and joining it with the original datasource to include</span>
<span class="c1"># other columns doesn't appear to speed up the process but it doesn't</span>
<span class="c1"># appear to slow it down either so all columns of interest are in this</span>
<span class="c1"># query.</span>

<span class="n">out_of_date_details_sql</span> <span class="o">=</span> <span class="p">(</span><span class="s2">""</span>
<span class="s2">"SELECT "</span>
    <span class="s2">"client_id, "</span>
    <span class="s2">"build.version, "</span>
    <span class="s2">"session_length, "</span>
    <span class="s2">"settings.update.enabled, "</span>
    <span class="s2">"subsession_start_date, "</span>
    <span class="s2">"subsession_length, "</span>
    <span class="s2">"update_check_code_notify, "</span>
    <span class="s2">"update_check_extended_error_notify, "</span>
    <span class="s2">"update_check_no_update_notify, "</span>
    <span class="s2">"update_not_pref_update_auto_notify, "</span>
    <span class="s2">"update_ping_count_notify, "</span>
    <span class="s2">"update_unable_to_apply_notify, "</span>
    <span class="s2">"update_download_code_partial, "</span>
    <span class="s2">"update_download_code_complete, "</span>
    <span class="s2">"update_state_code_partial_stage, "</span>
    <span class="s2">"update_state_code_complete_stage, "</span>
    <span class="s2">"update_state_code_unknown_stage, "</span>
    <span class="s2">"update_state_code_partial_startup, "</span>
    <span class="s2">"update_state_code_complete_startup, "</span>
    <span class="s2">"update_state_code_unknown_startup, "</span>
    <span class="s2">"update_status_error_code_complete_startup, "</span>
    <span class="s2">"update_status_error_code_partial_startup, "</span>
    <span class="s2">"update_status_error_code_unknown_startup, "</span>
    <span class="s2">"update_status_error_code_complete_stage, "</span>
    <span class="s2">"update_status_error_code_partial_stage, "</span>
    <span class="s2">"update_status_error_code_unknown_stage "</span>
<span class="s2">"{}"</span>
<span class="s2">"WHERE "</span>
    <span class="s2">"{} AND "</span>
    <span class="s2">"{} AND "</span>
    <span class="s2">"build.version[0] &lt; '{}.' AND "</span>
    <span class="s2">"build.version[0] &gt;= '{}.'"</span>
<span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">longitudinal_from_sql</span><span class="p">,</span>
           <span class="n">common_where_sql</span><span class="p">,</span>
           <span class="n">build_version_where_sql</span><span class="p">,</span>
           <span class="nb">str</span><span class="p">(</span><span class="n">latest_version</span> <span class="o">-</span> <span class="n">up_to_date_releases</span><span class="p">),</span>
           <span class="nb">str</span><span class="p">(</span><span class="n">min_version</span><span class="p">))</span>
<span class="n">out_of_date_details_sql</span>
</pre></div>
<p>Run the out of date details SQL query.</p>
<div class="codehilite"><pre><span></span><span class="n">out_of_date_details_df</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">out_of_date_details_sql</span><span class="p">)</span>
</pre></div>
<p>Create the RDD used to further restrict which clients are out of date
to focus on clients that are of concern and potentially of concern.</p>
<div class="codehilite"><pre><span></span><span class="n">out_of_date_details_rdd</span> <span class="o">=</span> <span class="n">out_of_date_details_df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<h3 id="the-next-several-cells-are-to-find-the-clients-that-are-out-of-date-potentially-of-concern-so-they-can-be-excluded-from-the-out-of-date-of-concern-clients">The next several cells are to find the clients that are “out of date, potentially of concern” so they can be excluded from the “out of date, of concern” clients.</h3>
<p>Create an RDD of out of date telemetry pings that have and don’t have
a previous telemetry ping with a version that is up to date along
with a dictionary of the count of True and False.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">has_out_of_date_max_version_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"50.1.0"</span> <span class="ow">or</span>
             <span class="n">p</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span> <span class="ow">and</span>
            <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">earliest_up_to_date_version</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

<span class="c1"># RegEx for a valid release versions except for 50.1.0 which is handled separately.</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">'^[0-9]{2,3}</span><span class="se">\\</span><span class="s1">.0[</span><span class="se">\\</span><span class="s1">.0-9]*$'</span><span class="p">)</span>

<span class="n">has_out_of_date_max_version_rdd</span> <span class="o">=</span> <span class="n">out_of_date_details_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">has_out_of_date_max_version_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">has_out_of_date_max_version_dict</span> <span class="o">=</span> <span class="n">has_out_of_date_max_version_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">has_out_of_date_max_version_dict</span>
</pre></div>
<p>Create an RDD of the telemetry pings that have a previous telemetry ping
with a version that is up to date.</p>
<div class="codehilite"><pre><span></span><span class="n">has_out_of_date_max_version_true_rdd</span> <span class="o">=</span> <span class="n">has_out_of_date_max_version_rdd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<p>Create an RDD of out of date telemetry pings that have and have not
sent an update telemtry ping for any version of Firefox along with a
dictionary of the count of True and False.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">has_update_ping_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
        <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_check_code_notify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span>
         <span class="n">ping</span><span class="o">.</span><span class="n">update_check_no_update_notify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)):</span>
        <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">has_update_ping_rdd</span> <span class="o">=</span> <span class="n">has_out_of_date_max_version_true_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">has_update_ping_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">has_update_ping_dict</span> <span class="o">=</span> <span class="n">has_update_ping_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">has_update_ping_dict</span>
</pre></div>
<p>Create an RDD of the telemetry pings that have an update telemtry
ping for any version of Firefox.</p>
<div class="codehilite"><pre><span></span><span class="n">has_update_ping_true_rdd</span> <span class="o">=</span> <span class="n">has_update_ping_rdd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<p>Create an RDD of out of date telemetry pings that have and have not
ran this version of Firefox for more than the amount of seconds as
specified by min_subsession_seconds along with a dictionary of the
count of True and False.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">has_min_subsession_length_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">seconds</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="n">min_subsession_seconds</span> <span class="ow">and</span>
           <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">subsession_start_date</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">subsession_start_date</span><span class="p">[</span><span class="n">index</span><span class="p">][:</span><span class="mi">10</span><span class="p">],</span>
                                        <span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">min_subsession_date</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

            <span class="n">seconds</span> <span class="o">+=</span> <span class="n">ping</span><span class="o">.</span><span class="n">subsession_length</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1"># catch *all* exceptions</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">seconds</span> <span class="o">&gt;=</span> <span class="n">min_subsession_seconds</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">has_min_subsession_length_rdd</span> <span class="o">=</span> <span class="n">has_update_ping_true_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">has_min_subsession_length_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">has_min_subsession_length_dict</span> <span class="o">=</span> <span class="n">has_min_subsession_length_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">has_min_subsession_length_dict</span>
</pre></div>
<p>Create an RDD of the telemetry pings that have ran this version of
Firefox for more than the amount of seconds as specified by
min_subsession_seconds.</p>
<div class="codehilite"><pre><span></span><span class="n">has_min_subsession_length_true_rdd</span> <span class="o">=</span> <span class="n">has_min_subsession_length_rdd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<p>Create an RDD of out of date telemetry pings that have and have not
sent the minimum number of update pings as specified by
min_update_ping_count for this version of Firefox along with a
dictionary of the count of True and False.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">has_min_update_ping_count_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">update_ping_count_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">update_ping_count_total</span> <span class="o">&lt;</span> <span class="n">min_update_ping_count</span> <span class="ow">and</span>
           <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">):</span>

        <span class="n">pingCount</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="c1"># Is this an update ping or just a placeholder for the telemetry ping?</span>
        <span class="k">if</span> <span class="n">pingCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">subsession_start_date</span><span class="p">[</span><span class="n">index</span><span class="p">][:</span><span class="mi">10</span><span class="p">],</span>
                                            <span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">min_subsession_date</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

            <span class="k">except</span><span class="p">:</span> <span class="c1"># catch *all* exceptions</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="c1"># Is there also a valid update check code or no update telemetry ping?</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_check_code_notify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_check_code_notify</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">index</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_check_code_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">update_ping_count_total</span> <span class="o">+=</span> <span class="n">pingCount</span>
                        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_check_no_update_notify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_check_no_update_notify</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">index</span> <span class="ow">and</span>
                <span class="n">ping</span><span class="o">.</span><span class="n">update_check_no_update_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">update_ping_count_total</span> <span class="o">+=</span> <span class="n">pingCount</span>

        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">update_ping_count_total</span> <span class="o">&lt;</span> <span class="n">min_update_ping_count</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

    <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">has_min_update_ping_count_rdd</span> <span class="o">=</span> <span class="n">has_min_subsession_length_true_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">has_min_update_ping_count_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">has_min_update_ping_count_dict</span> <span class="o">=</span> <span class="n">has_min_update_ping_count_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">has_min_update_ping_count_dict</span>
</pre></div>
<p>Create an RDD of the telemetry pings that have sent the minimum
number of update pings as specified by min_update_ping_count.</p>
<div class="codehilite"><pre><span></span><span class="n">has_min_update_ping_count_true_rdd</span> <span class="o">=</span> <span class="n">has_min_update_ping_count_rdd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<p>Create an RDD of out of date telemetry pings that are supported and
are not supported based on whether they have not received or have
received the unsupported update xml for the last update check along
with a dictionary of the count of True and False.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">is_supported_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">update_ping_count_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">update_ping_count_total</span> <span class="o">&lt;</span> <span class="n">min_update_ping_count</span> <span class="ow">and</span>
           <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">):</span>
        <span class="n">pingCount</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="c1"># Is this an update ping or just a placeholder for the telemetry ping?</span>
        <span class="k">if</span> <span class="n">pingCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Is there also a valid update check code or no update telemetry ping?</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_check_code_notify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_check_code_notify</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">index</span> <span class="ow">and</span>
                <span class="n">ping</span><span class="o">.</span><span class="n">update_check_code_notify</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">28</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">is_supported_rdd</span> <span class="o">=</span> <span class="n">has_min_update_ping_count_true_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">is_supported_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">is_supported_dict</span> <span class="o">=</span> <span class="n">is_supported_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">is_supported_dict</span>
</pre></div>
<p>Create an RDD of the telemetry pings that are supported based on
whether they have not received or have received the unsupported
update xml for the last update check.</p>
<div class="codehilite"><pre><span></span><span class="n">is_supported_true_rdd</span> <span class="o">=</span> <span class="n">is_supported_rdd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<p>Create an RDD of out of date telemetry pings that have and don’t have
the ability to apply an update along with a dictionary of the count 
of True and False.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">is_able_to_apply_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Only check the last value for update_unable_to_apply_notify</span>
            <span class="c1"># to determine if the client is unable to apply.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_unable_to_apply_notify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                <span class="n">ping</span><span class="o">.</span><span class="n">update_unable_to_apply_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Missing update unable to apply value!"</span><span class="p">)</span>

<span class="n">is_able_to_apply_rdd</span> <span class="o">=</span> <span class="n">is_supported_true_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">is_able_to_apply_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">is_able_to_apply_dict</span> <span class="o">=</span> <span class="n">is_able_to_apply_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">is_able_to_apply_dict</span>
</pre></div>
<p>Create an RDD of the telemetry pings that have the ability to apply
an update.</p>
<div class="codehilite"><pre><span></span><span class="n">is_able_to_apply_true_rdd</span> <span class="o">=</span> <span class="n">is_able_to_apply_rdd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<p>Create an RDD of out of date telemetry pings that have and don’t have
application update enabled via policy along with a dictionary of the
count of True and False.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">has_update_enabled_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># If there is an update ping and settings.update.enabled has a value</span>
            <span class="c1"># for the same telemetry submission then use the value of</span>
            <span class="c1"># settings.update.enabled to determine whether app update is enabled.</span>
            <span class="c1"># This isn't 100% accurate because the update ping and the value for</span>
            <span class="c1"># settings.update.enabled are gathered at different times but it is</span>
            <span class="c1"># accurate enough for this report.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                <span class="n">ping</span><span class="o">.</span><span class="n">enabled</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Missing update enabled value!"</span><span class="p">)</span>

<span class="n">has_update_enabled_rdd</span> <span class="o">=</span> <span class="n">is_able_to_apply_true_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">has_update_enabled_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">has_update_enabled_dict</span> <span class="o">=</span> <span class="n">has_update_enabled_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">has_update_enabled_dict</span>
</pre></div>
<h3 id="the-next-several-cells-categorize-the-clients-that-are-out-of-date-of-concern">The next several cells categorize the clients that are “out of date, of concern”.</h3>
<p>Create a reference to the dictionary which will be written to the
JSON that populates the web page data. This way the reference in the
web page never changes. A reference is all that is needed since the
dictionary is not modified.</p>
<div class="codehilite"><pre><span></span><span class="n">of_concern_dict</span> <span class="o">=</span> <span class="n">has_update_enabled_dict</span>
</pre></div>
<p>Create an RDD of the telemetry pings that have the
application.update.enabled preference set to True.</p>
<p>This RDD is created from the last “out of date, potentially of concern”
RDD and it is named of_concern_true_rdd to simplify the addition of new code
without having to modify consumers of the RDD.</p>
<div class="codehilite"><pre><span></span><span class="n">of_concern_true_rdd</span> <span class="o">=</span> <span class="n">has_update_enabled_rdd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry ping client
versions along with a dictionary of the count of each version.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">by_version_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ping</span>

<span class="n">of_concern_by_version_rdd</span> <span class="o">=</span> <span class="n">of_concern_true_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">by_version_mapper</span><span class="p">)</span>
<span class="n">of_concern_by_version_dict</span> <span class="o">=</span> <span class="n">of_concern_by_version_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">of_concern_by_version_dict</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry ping update check
codes along with a dictionary of the count of each update check code.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">check_code_notify_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="n">ping</span><span class="o">.</span><span class="n">update_check_code_notify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_check_code_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_check_no_update_notify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                <span class="n">ping</span><span class="o">.</span><span class="n">update_check_no_update_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ping</span>

        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">check_code_notify_of_concern_rdd</span> <span class="o">=</span> <span class="n">of_concern_true_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">check_code_notify_mapper</span><span class="p">)</span>
<span class="n">check_code_notify_of_concern_dict</span> <span class="o">=</span> <span class="n">check_code_notify_of_concern_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">check_code_notify_of_concern_dict</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry pings that had a
general failure for the update check. The general failure codes are:
<em> CHK_GENERAL_ERROR_PROMPT: 22
</em> CHK_GENERAL_ERROR_SILENT: 23</p>
<div class="codehilite"><pre><span></span><span class="n">check_code_notify_general_error_of_concern_rdd</span> <span class="o">=</span> \
    <span class="n">check_code_notify_of_concern_rdd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">22</span> <span class="ow">or</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">23</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry ping update check
extended error values for the clients that had a general failure for
the update check along with a dictionary of the count of the error
values.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">check_ex_error_notify_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="n">ping</span><span class="o">.</span><span class="n">update_check_extended_error_notify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key_name</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_check_extended_error_notify</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_check_extended_error_notify</span><span class="p">[</span><span class="n">key_name</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="n">key_name</span> <span class="o">=</span> <span class="n">key_name</span><span class="p">[</span><span class="mi">17</span><span class="p">:]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">key_name</span> <span class="o">=</span> <span class="n">key_name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">key_name</span><span class="p">),</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">check_ex_error_notify_of_concern_rdd</span> <span class="o">=</span> <span class="n">check_code_notify_general_error_of_concern_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">check_ex_error_notify_mapper</span><span class="p">)</span>
<span class="n">check_ex_error_notify_of_concern_dict</span> <span class="o">=</span> <span class="n">check_ex_error_notify_of_concern_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">check_ex_error_notify_of_concern_dict</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry ping update
download codes along with a dictionary of the count of the codes.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">download_code_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_download_code_partial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_download_code_partial</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_download_code_complete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_download_code_complete</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">download_code_of_concern_rdd</span> <span class="o">=</span> <span class="n">of_concern_true_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">download_code_mapper</span><span class="p">)</span>
<span class="n">download_code_of_concern_dict</span> <span class="o">=</span> <span class="n">download_code_of_concern_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">download_code_of_concern_dict</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry ping staged update
state codes along with a dictionary of the count of the codes.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">state_code_stage_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_partial_stage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_partial_stage</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_complete_stage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_complete_stage</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_unknown_stage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_unknown_stage</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">state_code_stage_of_concern_rdd</span> <span class="o">=</span> <span class="n">of_concern_true_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">state_code_stage_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">state_code_stage_of_concern_dict</span> <span class="o">=</span> <span class="n">state_code_stage_of_concern_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">state_code_stage_of_concern_dict</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry pings that failed
to stage an update.
* STATE_FAILED: 12</p>
<div class="codehilite"><pre><span></span><span class="n">state_code_stage_failed_of_concern_rdd</span> <span class="o">=</span> \
    <span class="n">state_code_stage_of_concern_rdd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry ping staged update
state failure codes along with a dictionary of the count of the codes.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">state_failure_code_stage_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_status_error_code_partial_stage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_status_error_code_partial_stage</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_status_error_code_complete_stage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_status_error_code_complete_stage</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_status_error_code_unknown_stage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_status_error_code_unknown_stage</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">state_failure_code_stage_of_concern_rdd</span> <span class="o">=</span> <span class="n">state_code_stage_failed_of_concern_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">state_failure_code_stage_mapper</span><span class="p">)</span>
<span class="n">state_failure_code_stage_of_concern_dict</span> <span class="o">=</span> <span class="n">state_failure_code_stage_of_concern_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">state_failure_code_stage_of_concern_dict</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry ping startup
update state codes along with a dictionary of the count of the codes.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">state_code_startup_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_partial_startup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_partial_startup</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_complete_startup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_complete_startup</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_unknown_startup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_unknown_startup</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">state_code_startup_of_concern_rdd</span> <span class="o">=</span> <span class="n">of_concern_true_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">state_code_startup_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">state_code_startup_of_concern_dict</span> <span class="o">=</span> <span class="n">state_code_startup_of_concern_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">state_code_startup_of_concern_dict</span>
</pre></div>
<p>Create an RDD of the telemetry pings that have ping startup update state code equal to 12.</p>
<div class="codehilite"><pre><span></span><span class="n">state_code_startup_failed_of_concern_rdd</span> <span class="o">=</span> \
    <span class="n">state_code_startup_of_concern_rdd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry ping startup
update state failure codes along with a dictionary of the count of the
codes.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">state_failure_code_startup_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_status_error_code_partial_startup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_status_error_code_partial_startup</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_status_error_code_complete_startup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_status_error_code_complete_startup</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_status_error_code_unknown_startup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_status_error_code_unknown_startup</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">code_index</span><span class="p">,</span> <span class="n">ping</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ping</span>
                <span class="n">code_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">state_failure_code_startup_of_concern_rdd</span> <span class="o">=</span> <span class="n">state_code_startup_failed_of_concern_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">state_failure_code_startup_mapper</span><span class="p">)</span>
<span class="n">state_failure_code_startup_of_concern_dict</span> <span class="o">=</span> <span class="n">state_failure_code_startup_of_concern_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">state_failure_code_startup_of_concern_dict</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry pings that have
and have not received only no updates available during the update
check for their current version of Firefox along with a dictionary
of the count of values.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">has_only_no_update_found_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_check_no_update_notify</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">current_version</span> <span class="o">!=</span> <span class="n">version</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_ping_count_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># If there is an update ping and update_check_no_update_notify</span>
            <span class="c1"># has a value equal to 0 then the update check returned a</span>
            <span class="c1"># value other than no update found. This could be improved by</span>
            <span class="c1"># checking the check value for error conditions and ignoring</span>
            <span class="c1"># those codes and ignoring the check below for those cases.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_check_no_update_notify</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

    <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">has_only_no_update_found_rdd</span> <span class="o">=</span> <span class="n">of_concern_true_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">has_only_no_update_found_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">has_only_no_update_found_dict</span> <span class="o">=</span> <span class="n">has_only_no_update_found_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">has_only_no_update_found_dict</span>
</pre></div>
<p>Create an RDD of the telemetry pings that have not received only no updates
available during the update check for their current version of Firefox.</p>
<div class="codehilite"><pre><span></span><span class="n">has_only_no_update_found_false_rdd</span> <span class="o">=</span> <span class="n">has_only_no_update_found_rdd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry pings that have and
don’t have any update download pings for their current version of
Firefox along with a dictionary of the count of the values.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">has_no_download_code_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">current_version</span> <span class="o">!=</span> <span class="n">version</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_download_code_partial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_download_code_partial</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

        <span class="k">if</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_download_code_complete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">code_value</span> <span class="ow">in</span> <span class="n">ping</span><span class="o">.</span><span class="n">update_download_code_complete</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">code_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

    <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">has_no_download_code_rdd</span> <span class="o">=</span> <span class="n">has_only_no_update_found_false_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">has_no_download_code_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">has_no_download_code_dict</span> <span class="o">=</span> <span class="n">has_no_download_code_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">has_no_download_code_dict</span>
</pre></div>
<p>Create an RDD of the telemetry pings that don’t have any update
download pings for their current version of Firefox.</p>
<div class="codehilite"><pre><span></span><span class="n">has_no_download_code_false_rdd</span> <span class="o">=</span> <span class="n">has_no_download_code_rdd</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
<p>Create an RDD of out of date, of concern telemetry pings that have and
don’t have an update failure state for their current version of
Firefox along with a dictionary of the count of the values.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">has_update_apply_failure_mapper</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">ping</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">current_version</span> <span class="o">!=</span> <span class="n">version</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_partial_startup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
            <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_partial_startup</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">12</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_complete_startup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
            <span class="n">ping</span><span class="o">.</span><span class="n">update_state_code_complete_startup</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">12</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ping</span>

    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ping</span>

<span class="n">has_update_apply_failure_rdd</span> <span class="o">=</span> <span class="n">has_no_download_code_false_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">has_update_apply_failure_mapper</span><span class="p">)</span>
<span class="n">has_update_apply_failure_dict</span> <span class="o">=</span> <span class="n">has_update_apply_failure_rdd</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">has_update_apply_failure_dict</span>
</pre></div>
<p>Create a reference to the dictionary which will be written to the
JSON that populates the web page data. This way the reference in the
web page never changes. A reference is all that is needed since the
dictionary is not modified.</p>
<div class="codehilite"><pre><span></span><span class="n">of_concern_categorized_dict</span> <span class="o">=</span> <span class="n">has_update_apply_failure_dict</span>
</pre></div>
<p>Create the JSON that will be written to a file for the report.</p>
<div class="codehilite"><pre><span></span><span class="n">results_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"reportDetails"</span><span class="p">:</span> <span class="n">report_details_dict</span><span class="p">,</span>
                <span class="s2">"summary"</span><span class="p">:</span> <span class="n">summary_dict</span><span class="p">,</span>
                <span class="s2">"hasOutOfDateMaxVersion"</span><span class="p">:</span> <span class="n">has_out_of_date_max_version_dict</span><span class="p">,</span>
                <span class="s2">"hasUpdatePing"</span><span class="p">:</span> <span class="n">has_update_ping_dict</span><span class="p">,</span>
                <span class="s2">"hasMinSubsessionLength"</span><span class="p">:</span> <span class="n">has_min_subsession_length_dict</span><span class="p">,</span>
                <span class="s2">"hasMinUpdatePingCount"</span><span class="p">:</span> <span class="n">has_min_update_ping_count_dict</span><span class="p">,</span>
                <span class="s2">"isSupported"</span><span class="p">:</span> <span class="n">is_supported_dict</span><span class="p">,</span>
                <span class="s2">"isAbleToApply"</span><span class="p">:</span> <span class="n">is_able_to_apply_dict</span><span class="p">,</span>
                <span class="s2">"hasUpdateEnabled"</span><span class="p">:</span> <span class="n">has_update_enabled_dict</span><span class="p">,</span>
                <span class="s2">"ofConcern"</span><span class="p">:</span> <span class="n">of_concern_dict</span><span class="p">,</span>
                <span class="s2">"hasOnlyNoUpdateFound"</span><span class="p">:</span> <span class="n">has_only_no_update_found_dict</span><span class="p">,</span>
                <span class="s2">"hasNoDownloadCode"</span><span class="p">:</span> <span class="n">has_no_download_code_dict</span><span class="p">,</span>
                <span class="s2">"hasUpdateApplyFailure"</span><span class="p">:</span> <span class="n">has_update_apply_failure_dict</span><span class="p">,</span>
                <span class="s2">"ofConcernCategorized"</span><span class="p">:</span> <span class="n">of_concern_categorized_dict</span><span class="p">,</span>
                <span class="s2">"ofConcernByVersion"</span><span class="p">:</span> <span class="n">of_concern_by_version_dict</span><span class="p">,</span>
                <span class="s2">"checkCodeNotifyOfConcern"</span><span class="p">:</span> <span class="n">check_code_notify_of_concern_dict</span><span class="p">,</span>
                <span class="s2">"checkExErrorNotifyOfConcern"</span><span class="p">:</span> <span class="n">check_ex_error_notify_of_concern_dict</span><span class="p">,</span>
                <span class="s2">"downloadCodeOfConcern"</span><span class="p">:</span> <span class="n">download_code_of_concern_dict</span><span class="p">,</span>
                <span class="s2">"stateCodeStageOfConcern"</span><span class="p">:</span> <span class="n">state_code_stage_of_concern_dict</span><span class="p">,</span>
                <span class="s2">"stateFailureCodeStageOfConcern"</span><span class="p">:</span> <span class="n">state_failure_code_stage_of_concern_dict</span><span class="p">,</span>
                <span class="s2">"stateCodeStartupOfConcern"</span><span class="p">:</span> <span class="n">state_code_startup_of_concern_dict</span><span class="p">,</span>
                <span class="s2">"stateFailureCodeStartupOfConcern"</span><span class="p">:</span> <span class="n">state_failure_code_startup_of_concern_dict</span><span class="p">}</span>
<span class="n">results_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results_dict</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">results_json</span>
</pre></div>
<p>Save the output to be uploaded automatically once the job completes.
The file will be stored at:
* https://analysis-output.telemetry.mozilla.org/app-update/data/out-of-date/FILENAME</p>
<div class="codehilite"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">"./output/"</span> <span class="o">+</span> <span class="n">report_filename</span> <span class="o">+</span> <span class="s2">".json"</span>
<span class="k">if</span> <span class="n">no_upload</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">results_json</span><span class="p">)</span>

    <span class="n">bucket</span> <span class="o">=</span> <span class="s2">"telemetry-public-analysis-2"</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s2">"app-update/data/out-of-date/"</span>
    <span class="n">timestamped_s3_key</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">report_filename</span> <span class="o">+</span> <span class="s2">".json"</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">'s3'</span><span class="p">,</span> <span class="s1">'us-west-2'</span><span class="p">)</span>
    <span class="n">transfer</span> <span class="o">=</span> <span class="n">S3Transfer</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
    <span class="n">transfer</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">timestamped_s3_key</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">{</span><span class="s1">'ContentType'</span><span class="p">:</span><span class="s1">'application/json'</span><span class="p">})</span>

<span class="k">print</span> <span class="s2">"Filename: "</span> <span class="o">+</span> <span class="n">filename</span>
</pre></div>
<p>Get the time when this job ended.</p>
<div class="codehilite"><pre><span></span><span class="n">end_time</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="k">print</span> <span class="s2">"End: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S"</span><span class="p">))</span>
</pre></div>
<p>Get the elapsed time it took to run this job.</p>
<div class="codehilite"><pre><span></span><span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
<span class="k">print</span> <span class="s2">"Elapsed Seconds: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed_time</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div></body></html>
<div>

</div>


<br/>
<div class="row">
<div class="col-md-12">
</div>
</div>




<script type="text/javascript">
            $("#searchbar")[0].setSelectionRange(1000, 1000);

            $('#searchbar').typeahead({
                hint: false,
                highlight: true,
                minLength: 1
              },
              {
                name: 'knowledge_posts',
                limit: 10,
                display: function (item) {
                  return item.title + " - " + item.author;
                },
                templates: {
                  empty: Handlebars.compile(
                    '<div class="tt-not-found">' +
                      'Unable to find any posts that match the current query' +
                      '</div>'
                  ),
                  suggestion: function(data) {
                    return '<p style="overflow-wrap:break-word"><strong class="text-rausch">' + data.title + '</strong> – ' + data.author + '</p>';
                  }
                },
                source: function(q, sync, async) {
                  $.ajax('/ajax/index/typeahead?search=' + q,
                  {
                    success: function(data,status){ async(JSON.parse(data)); }
                  })
                }
              });


            $('#searchbar').bind('typeahead:select', function(obj, datum, name) {
              window.location = '/post/'+encodeURIComponent(datum.path);
            });

            $('#searchbar').keypress(function(event){
              var keycode = (event.keyCode ? event.keyCode : event.which);
              if(keycode == '13'){
                var path = document.location.pathname;
                window.location = '/feed?filters=' + $('#searchbar').val()
              }
            });

            var padding = $('.tt-menu').outerWidth()
            $('.tt-menu').width($('#searchbar').width() + padding + "px")

        </script>
<script src="/static/legacy/knowledge-repo/js/tooltips.js" type="text/javascript"></script>
<script type="text/javascript">
$("document").ready(function(){
  var is_webeditor = false;
  
  var post_id = "4";
  var id = "None";
  var post_path = "projects/app_update_out_of_date.kp"
  var data_repo_github_root = ""
  tooltipsJx.initializeTooltips(is_webeditor, post_id, id, data_repo_github_root);

  $(".btn-rendered").on("click", function(){
    document.location.href = "/post/" + encodeURI(post_path);
  })

  $(".btn-raw").on("click", function(){
    document.location.href = "/post/" + encodeURI(post_path) + "?render=raw";
  })

  $(".btn-webeditor").on("click", function(){
    document.location.href = "/edit/" + encodeURI(post_path);
  })
});

</script>
<script src="/static/legacy/knowledge-repo/js/helpers.js"></script>
<script src="/static/legacy/knowledge-repo/js/tags.js" type="text/javascript"></script>
<script src="/static/legacy/knowledge-repo/js/icons.js" type="text/javascript"></script>
<script src="/static/legacy/knowledge-repo/js/comments.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js" type="text/javascript">
</script>
<script>
$(document).on('ready', function(){
  // Make the Rendered Markdown Button active
  $(".btn-rendered").addClass("btn-active");

  // Initialize headers
  helpersJx.linkifyHeaders();

  // Initialize comments
  var post_path = 'projects/app_update_out_of_date.kp';

  $("#post_comment_btn").on('click', function(){
      comment_author = 'knowledge_default';
      post_author = 'rstrong';
      post_title = 'Firefox Application Update Out Of Date dashboard';
      commentsJx.postComment(comment_author, post_author, post_title, post_path);
      location.reload();
  });

  all_comment_delete_buttons = $("[id^=delete_comment]")
  $.each(all_comment_delete_buttons, function(i,v){
      $(v).on("click", function(){
          var id = v.id;
          var comment_id = id.split("__")[1];
          if(comment_id) {
            commentsJx.deleteComment(post_path, comment_id)
            location.reload();
          }
      });
  });
  $(document.body).on('click',"button[id^=tag-subscription]",function () {
    tagsJx.addTagSubscriptionListener($(this)[0]);
  });
})

//Turn all the headers to be links
//h1 = Title, don't want that
var all_headers = [$("h2"), $("h3"), $("h4"), $("h5"), $("h6")]
$.each(all_headers, function(index, value){
  $.each(value, function(i, v){
    var inner_html = v.innerHTML
    inner_html_no_special = inner_html.replace(/[^a-zA-Z\- ]/g, "")
    var inner_link = "#" + inner_html_no_special.toLowerCase().split(" ").join("-")
    v.innerHTML = "<a href='" + inner_link + "' class=link-reset>" + inner_html + "</a>"
  })
})

//turn all the tags into links, similar to what's done on the feed page
var tags = $("#renderedMarkdown .metadata .tags")[0]
var tags_list = ['firefox', 'app_update']
var subscriptions_list = []
$.each(tags_list, function(i,tag){
  ahref = document.createElement("a")
  e_tag = encodeURIComponent(tag)
  f_tag = tag.replace("/", "__")
  tag_name = "#" + tag
  tag_subscription_button_id_name = "tag-subscription-" + i + "__" + f_tag
  ahref.setAttribute("data-container", "body")
  ahref.setAttribute("data-toggle", "popover")
  ahref.setAttribute("data-placement", "bottom")
  ahref.setAttribute("data-html", "true")
  ahref.setAttribute("data-tag-name", f_tag)
  if (subscriptions_list.indexOf(tag) >= 0) {
    ahref.setAttribute("class", "label label-subscribed pop")
    ahref.setAttribute("data-content", "<div class='content'>" +
                  " <button class='btn btn-small btn-primary btn-unsubscribe'" +
                        " title='' " +
                          " id='" + tag_subscription_button_id_name + "'> " +
                    " <i class='glyphicon glyphicon-remove-sign glyphicon-white'></i>Unsubscribe " +
                  " </button> " +
                  " </div>")
  } else {
    ahref.setAttribute("class", "label label-unsubscribed pop")
    ahref.setAttribute("data-content", "<div class='content'>" +
                  " <button class='btn btn-small btn-default btn-subscribe'" +
                        " title='' " +
                          " id='" + tag_subscription_button_id_name + "'> " +
                    " <i class='glyphicon glyphicon-ok-sign glyphicon-filled'></i>Subscribe " +
                  " </button> " +
                  " </div>")
  }
  ahref.setAttribute("href", "/tag_pages?tag=" + e_tag)
  ahref.setAttribute("style", "font-weight:normal")
  if (i == 0){
    ahref.innerHTML = " "
    colon = document.createElement("text")
    colon.innerHTML = "<b>Tags</b>: "
    tags.appendChild(colon)
  }
  ahref.innerHTML = ahref.innerHTML + tag_name
  tags.appendChild(ahref)
  if (i != tags_list.length - 1){
    comma = document.createElement("text")
    comma.innerText = ", "
    tags.appendChild(comma)
  }
})
tags.nextSibling.remove()

tags.innerHTML += "<i class='glyphicon glyphicon-edit icon-gray' style='font-size:12pt; padding-left:4px' id='tooltip-edit_tags'></i>"

$(".pop").popover({ trigger: "manual" , html: true, animation:false, delay: 100})
  .on("mouseenter", function () {
      var _this = this;
      $(this).popover("show");
      $(".popover").on("mouseleave", function () {
          $(_this).popover('hide');
      });
  }).on("mouseleave", function () {
      var _this = this;
      setTimeout(function () {
          if (!$(".popover:hover").length) {
              $(_this).popover("hide");
          }
      }, 300);
});

$('#tooltip-edit_tags').click(function(){
  $('#tooltip-edit_tags')[0].setAttribute("style", "display:none")
  previousSibling = $("#tooltip-edit_tags")[0].previousSibling
  tags_string = tags_list.join(", ")
  form = document.createElement("form")
  input = document.createElement("input")
  tags_text = document.createElement("text")
  icon_class = document.createElement("i")
  icon_class.setAttribute("class", "glyphicon glyphicon-upload icon-gray")
  icon_class.setAttribute("style", "font-size:23px; padding-left:4px")
  icon_class.setAttribute("id", "tooltip-save_tags")
  tags_text.innerText = "Tags: "
  input.setAttribute('type', 'text')
  input.setAttribute('name', 'tags_list')
  input.setAttribute('value', tags_string)
  input.setAttribute('style', 'width:75%; display: inline-block')
  input.setAttribute('id' , 'change_tags')
  form.appendChild(tags_text)
  tags.textContent = " "
  form.appendChild(input)
  form.appendChild(icon_class)
  tags.appendChild(form)


  $("#tooltip-save_tags").click(function(){
    tags_string = $("#change_tags")[0].value
    tags_list = tags_string.split(",")

    var re = /^[a-z0-9\-\_\:\/]+$/i
    var good = true
    for (var i = 0; i < tags_list.length; i++){
      tag = tags_list[i]
      if (tag.length == 0){
        alert("There is a tag with length 0 - possible a trailing comma?")
        good = false
        break
      } else {
        tag_name = tag.trim()
        if (!(re.test(tag_name))){
           alert("The tag contains special characters. Make sure there are only alphanumeric characters in your tag")
           good = false
           break
        }
      }
    }
    if (good) {
    var postContent = {}
      postContent['tags'] = tags_string
      $.ajax({
        type: "POST",
        dataType: "json",
        data: JSON.stringify(postContent),
        contentType: "application/json",
        url: '/tag_list?post_path=projects/app_update_out_of_date.kp',
        async: false
      });
      location.reload()
    }
  })

  tags.nextSibling.remove()

  // Allow user to edit tags
  var edit_icon = iconsJx.createEditTagsIcon();
  $(tags).after(edit_icon);

  $("#tooltip-edit_tags").on("click", function(){
      var edit_tooltip = $("#tooltip-edit_tags");
      edit_tooltip.attr("style", "display:none");

      var tags_string = tags_list.join(", ");
      var form = $("<form>");
      var input = $("<input>");

      var tags_text = $("<text>");
      tags_text.html("Tags: ");


      var icon = iconsJx.createSaveTagsIcon();

      input.attr("type", "text");
      input.attr("name", "tags_list");
      input.attr("style", "width:75%; display: inline-block");
      input.attr("id", "change_tags");

      form.append(tags_text);
      tags.textContent = " ";
      tags_text.innerHTML = "Tags: ";
      form.append(input);
      form.append(icon);
      tags.appendChild(form[0]);
      $("#change_tags")[0].value = tags_string;


      $("#change_tags").keypress(function(e){
          if (e.which == 13){
              var tags_string = $("#change_tags")[0].value;
              var post_path = "projects/app_update_out_of_date.kp";
              tagsJx.changeAndSaveTags(post_path, tags_string);
              return false;
          };
      });


      $("#tooltip-save_tags").click(function(){
          var tags_string = $("#change_tags")[0].value;
          var post_path = "projects/app_update_out_of_date.kp";
          tagsJx.changeAndSaveTags(post_path, tags_string);
      });

       $("form").submit(function(){
          var tags_string = $("#change_tags")[0].value;
          var post_path = "projects/app_update_out_of_date.kp";
          tagsJx.changeAndSaveTags(post_path, tags_string);
          return false
      })
  });

});

</script>


