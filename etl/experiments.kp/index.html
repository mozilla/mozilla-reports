<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<title> Knowledge </title>
<!-- js includes at the top as post embedded js colliding -->
<script src="/static/legacy/knowledge-repo/modules/jquery/jquery.min.js"></script>
<script src="/static/legacy/knowledge-repo/modules/tether/js/tether.min.js"></script>
<script src="/static/legacy/knowledge-repo/modules/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/legacy/knowledge-repo/modules/bootstrap-slider/js/bootstrap-slider.min.js"></script>
<script src="/static/legacy/knowledge-repo/modules/typeahead.js/typeahead.bundle.min.js"></script>
<script src="/static/legacy/knowledge-repo/modules/handlebars/js/handlebars.js"></script>
<script src="/static/legacy/knowledge-repo/js/helpers.js"></script>
<script src="/static/legacy/knowledge-repo/modules/select2/js/select2.min.js"></script>
<script src="/static/legacy/knowledge-repo/modules/hightlight.pack.js/highlight.pack.js"></script>
<script src="/static/legacy/knowledge-repo/modules/marked.js/marked.js"></script>
<!-- require js is used for plotly, but has a bunch of collisions with other js packages
             make sure to have it be last js package imported -->
<script src="/static/legacy/knowledge-repo/modules/require.js/require.min.js"></script>
<!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/2.1.0/es5-shim.min.js"></script>
        <![endif]-->
<link href="/static/legacy/knowledge-repo/modules/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
<link href="/static/legacy/knowledge-repo/modules/bootstrap-slider/css/bootstrap-slider.min.css" rel="stylesheet"/>
<link href="/static/legacy/knowledge-repo/css/custom.css" rel="stylesheet" type="text/css"/>
<link href="/static/legacy/knowledge-repo/modules/select2/css/select2.min.css" rel="stylesheet" type="text/css"/>
<link href="https://fonts.googleapis.com/css?family=Lato:400,900|Playfair+Display|Source+Serif+Pro:400,700" rel="stylesheet" type="text/css"/>
<link href="/static/legacy/knowledge-repo/images/favicon.png" rel="shortcut icon"/>
<link href="/static/legacy/knowledge-repo/css/codehilite-friendly.css" rel="stylesheet"/>
<style>
            .spinner {
                position: fixed;
                top: 50%;
                left: 50%;
                margin-left: -50px; /* half width of the spinner gif */
                margin-top: -50px; /* half height of the spinner gif */
                text-align:center;
                z-index:1234;
                overflow: auto;
                width: 100px; /* width of the spinner gif */
                height: 102px; /*hight of the spinner gif +2px to fix IE8 issue */
            }

            .table {
              font-size: 14px;
            }

            .modal-content {
              max-width: 1024px;
            }

             

          </style>
</head>
<body>

<div class="container page-container">
<br/>
<div class="container-fluid">
<div class="row">
<div class="col-md-6">

</div>
<div class="col-md-2">
</div>

</div>
<div class="row col-md-12">
</div>
</div>
<div class="container-fluid">
<div class="row">
<div class="col-md-12">
<div id="renderedMarkdown">
<div class="metadata">
<h1>Experiment Job</h1>
<span class="authors"><a href="/feed?authors=Frank+Bertsch">Frank Bertsch</a></span>
<span class="date_created">February 01, 2017</span>
<span class="date_updated">(Last Updated: February 09, 2017)</span>
<span class="tldr"><p>We take all the pings from yesterday, get the information about any experiments: those that started, those running, and those that ended. These are aggregated by channel and outputted to files in s3.</p></span>

</div>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">date</span>
<span class="kn">import</span> <span class="nn">moztelemetry</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span>

<span class="c1"># get the desired target date from the environment, or run</span>
<span class="c1"># on 'yesterday' by default.</span>
<span class="n">yesterday</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
<span class="n">target_date</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="n">yesterday</span><span class="p">)</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">moztelemetry.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>

<span class="n">sample_rate</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'sample'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">pings</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_source</span><span class="p">(</span><span class="s2">"telemetry-experiments"</span><span class="p">)</span> \
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">submissionDate</span><span class="o">=</span><span class="n">target_date</span><span class="p">)</span> \
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">docType</span><span class="o">=</span><span class="s2">"main"</span><span class="p">)</span> \
                   <span class="o">.</span><span class="n">records</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">)</span> \
                   <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"environment"</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"build"</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"applicationName"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"Firefox"</span><span class="p">)</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">moztelemetry</span> <span class="kn">import</span> <span class="n">get_pings_properties</span>

<span class="n">subset</span> <span class="o">=</span> <span class="n">get_pings_properties</span><span class="p">(</span><span class="n">pings</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">"appUpdateChannel"</span><span class="p">:</span> <span class="s2">"meta/appUpdateChannel"</span><span class="p">,</span>
    <span class="s2">"log"</span><span class="p">:</span> <span class="s2">"payload/log"</span><span class="p">,</span>
    <span class="s2">"activeExperiment"</span><span class="p">:</span> <span class="s2">"environment/addons/activeExperiment/id"</span><span class="p">,</span>
    <span class="s2">"activeExperimentBranch"</span><span class="p">:</span> <span class="s2">"environment/addons/activeExperiment/branch"</span>
<span class="p">})</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="c1">### Setup data structures and constants ###</span>

<span class="n">ALLOWED_ENTRY_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'EXPERIMENT_ACTIVATION'</span><span class="p">,</span> <span class="s1">'EXPERIMENT_TERMINATION'</span><span class="p">)</span>

<span class="n">experiment</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'EXPERIMENT_ACTIVATION'</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> 
    <span class="s1">'active'</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> 
    <span class="s1">'EXPERIMENT_TERMINATION'</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">channel</span> <span class="o">=</span> <span class="p">{</span> 
    <span class="s1">'errors'</span><span class="p">:</span> <span class="p">[],</span> 
    <span class="s1">'experiments'</span><span class="p">:</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">get_empty_channel</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">ujson</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># This is a json object with {Date =&gt; {channel: count}}. It is created</span>
<span class="c1"># by the main_channel_counts plugin, and may be inaccurate if the ec2</span>
<span class="c1"># box crashed, but only for the day of the crash. If it crashes, the</span>
<span class="c1"># previous data will be lost.</span>
<span class="n">COUNTS_JSON_URI</span> <span class="o">=</span> <span class="s2">"https://pipeline-cep.prod.mozaws.net/dashboard_output/analysis.frank.main_channel_counts.counts.json"</span>

<span class="c1">### Aggregation functions, Spark job, output file creation ###</span>

<span class="k">def</span> <span class="nf">channel_ping_agg</span><span class="p">(</span><span class="n">channel_agg</span><span class="p">,</span> <span class="n">ping</span><span class="p">):</span>
    <span class="sd">"""Aggregate a channel with a ping"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"log"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ALLOWED_ENTRY_TYPES</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">exp_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">exp_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channel_agg</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">]:</span>
                    <span class="n">channel_agg</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">][</span><span class="n">exp_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
                <span class="n">channel_agg</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">][</span><span class="n">exp_id</span><span class="p">][</span><span class="n">entry</span><span class="p">][</span><span class="nb">tuple</span><span class="p">([</span><span class="n">reason</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">exp_id</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"activeExperiment"</span><span class="p">)</span>
        <span class="n">branch</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"activeExperimentBranch"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exp_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">branch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exp_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channel_agg</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">]:</span>
                <span class="n">channel_agg</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">][</span><span class="n">exp_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
            <span class="n">channel_agg</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">][</span><span class="n">exp_id</span><span class="p">][</span><span class="s1">'active'</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">channel_agg</span><span class="p">[</span><span class="s1">'errors'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'{}: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">channel_agg</span>

<span class="k">def</span> <span class="nf">channel_channel_agg</span><span class="p">(</span><span class="n">channel_agg_1</span><span class="p">,</span> <span class="n">channel_agg_2</span><span class="p">):</span>
    <span class="sd">"""Aggregate a channel with a channel"""</span>
    <span class="n">channel_agg_1</span><span class="p">[</span><span class="s1">'errors'</span><span class="p">]</span> <span class="o">+=</span> <span class="n">channel_agg_2</span><span class="p">[</span><span class="s1">'errors'</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">exp_id</span><span class="p">,</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">channel_agg_2</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">exp_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channel_agg_1</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">]:</span>
            <span class="n">channel_agg_1</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">][</span><span class="n">exp_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span><span class="p">,</span> <span class="n">exp_activities</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">exp_activity</span><span class="p">,</span> <span class="n">counts</span> <span class="ow">in</span> <span class="n">exp_activities</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">channel_agg_1</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">][</span><span class="n">exp_id</span><span class="p">][</span><span class="n">entry</span><span class="p">][</span><span class="n">exp_activity</span><span class="p">]</span> <span class="o">+=</span> <span class="n">counts</span>

    <span class="k">return</span> <span class="n">channel_agg_1</span>

<span class="k">def</span> <span class="nf">get_channel_or_other</span><span class="p">(</span><span class="n">ping</span><span class="p">):</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"appUpdateChannel"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"release"</span><span class="p">,</span> <span class="s2">"nightly"</span><span class="p">,</span> <span class="s2">"beta"</span><span class="p">,</span> <span class="s2">"aurora"</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">channel</span>
    <span class="k">return</span> <span class="s2">"OTHER"</span>

<span class="k">def</span> <span class="nf">aggregate_pings</span><span class="p">(</span><span class="n">pings</span><span class="p">):</span>
    <span class="sd">"""Get the channel experiments from an rdd of pings"""</span>
    <span class="k">return</span> <span class="n">pings</span>\
            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">get_channel_or_other</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="p">))</span>\
            <span class="o">.</span><span class="n">aggregateByKey</span><span class="p">(</span><span class="n">get_empty_channel</span><span class="p">(),</span> <span class="n">channel_ping_agg</span><span class="p">,</span> <span class="n">channel_channel_agg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_counts</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="sd">"""Add counts from a running CEP"""</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">COUNTS_JSON_URI</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">channel</span><span class="p">[</span><span class="s1">'total'</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_date</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cname</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">write_aggregate</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">filename_prefix</span><span class="o">=</span><span class="s1">'experiments'</span><span class="p">):</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">agg</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"total"</span><span class="p">:</span> <span class="n">channel</span><span class="p">[</span><span class="s1">'total'</span><span class="p">],</span>
            <span class="s2">"experiments"</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">exp_id</span><span class="p">,</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">channel</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">"experiments"</span><span class="p">][</span><span class="n">exp_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">"active"</span><span class="p">:</span> <span class="n">experiment</span><span class="p">[</span><span class="s1">'active'</span><span class="p">],</span>
                <span class="s2">"activations"</span><span class="p">:</span> <span class="n">experiment</span><span class="p">[</span><span class="s1">'EXPERIMENT_ACTIVATION'</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                <span class="s2">"terminations"</span><span class="p">:</span> <span class="n">experiment</span><span class="p">[</span><span class="s1">'EXPERIMENT_TERMINATION'</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
            <span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s2">"{}{}-{}.json.gz"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename_prefix</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">cname</span><span class="p">)</span>
        <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">ujson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filenames</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">### Setup Test Pings ###</span>

<span class="k">def</span> <span class="nf">make_ping</span><span class="p">(</span><span class="n">ae</span><span class="p">,</span> <span class="n">aeb</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">'activeExperiment'</span><span class="p">:</span> <span class="n">ae</span><span class="p">,</span>
             <span class="s1">'activeExperimentBranch'</span><span class="p">:</span> <span class="n">aeb</span><span class="p">,</span>
             <span class="s1">'appUpdateChannel'</span><span class="p">:</span> <span class="n">chan</span><span class="p">,</span>
             <span class="s1">'log'</span><span class="p">:</span> <span class="n">log</span><span class="p">}</span>

<span class="n">NUM_ACTIVATIONS</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">NUM_ACTIVES</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">NUM_TERMINATIONS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">TOTAL</span> <span class="o">=</span> <span class="n">NUM_ACTIVATIONS</span> <span class="o">+</span> <span class="n">NUM_ACTIVES</span> <span class="o">+</span> <span class="n">NUM_TERMINATIONS</span>

<span class="n">_channel</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">,</span> <span class="n">the_date</span> <span class="o">=</span> <span class="s1">'release'</span><span class="p">,</span> <span class="s1">'tls13-compat-ff51@experiments.mozilla.org'</span><span class="p">,</span> <span class="s1">'20140101'</span>
<span class="n">branch</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="s1">'branch'</span><span class="p">,</span> <span class="s1">'REJECTED'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'minBuildId'</span><span class="p">]</span>
<span class="n">log</span> <span class="o">=</span> <span class="p">[</span><span class="mi">17786</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span>

<span class="n">pings</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_ping</span><span class="p">(</span><span class="n">exp_id</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">_channel</span><span class="p">,</span> <span class="p">[])</span> 
             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">NUM_ACTIVES</span><span class="p">)]</span> <span class="o">+</span>\
        <span class="p">[</span><span class="n">make_ping</span><span class="p">(</span><span class="n">exp_id</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">_channel</span><span class="p">,</span> <span class="p">[[</span><span class="s1">'EXPERIMENT_ACTIVATION'</span><span class="p">]</span> <span class="o">+</span> <span class="n">log</span><span class="p">])</span> 
             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">NUM_ACTIVATIONS</span><span class="p">)]</span> <span class="o">+</span>\
        <span class="p">[</span><span class="n">make_ping</span><span class="p">(</span><span class="n">exp_id</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">_channel</span><span class="p">,</span> <span class="p">[[</span><span class="s1">'EXPERIMENT_TERMINATION'</span><span class="p">]</span> <span class="o">+</span> <span class="n">log</span><span class="p">])</span> 
             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">NUM_TERMINATIONS</span><span class="p">)]</span>

<span class="c1">### Setup expected result aggregate ###</span>

<span class="k">def</span> <span class="nf">channels_agg_assert</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">counts</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1">#Should just be the channel we provided</span>
    <span class="k">assert</span> <span class="n">channels</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">()</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="n">_channel</span><span class="p">]),</span> <span class="s1">'Incorrect channels: '</span> <span class="o">+</span> <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1">#just check this one channel now</span>
    <span class="n">release</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[</span><span class="n">_channel</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">release</span><span class="p">[</span><span class="s1">'errors'</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'Had Errors: '</span> <span class="o">+</span> <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">release</span><span class="p">[</span><span class="s1">'errors'</span><span class="p">])</span>

    <span class="c1">#now check experiment totals</span>
    <span class="k">assert</span> <span class="n">release</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">][</span><span class="n">exp_id</span><span class="p">][</span><span class="s1">'EXPERIMENT_ACTIVATION'</span><span class="p">][</span><span class="nb">tuple</span><span class="p">([</span><span class="n">reason</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">)]</span> <span class="o">==</span> <span class="n">NUM_ACTIVATIONS</span> <span class="o">*</span> <span class="n">counts</span><span class="p">,</span>\
            <span class="s1">'Expected '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">NUM_ACTIVATIONS</span> <span class="o">*</span> <span class="n">counts</span><span class="p">)</span> <span class="o">+</span> \
            <span class="s1">', Got '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">release</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">][</span><span class="n">exp_id</span><span class="p">][</span><span class="s1">'EXPERIMENT_ACTIVATION'</span><span class="p">][</span><span class="nb">tuple</span><span class="p">([</span><span class="n">reason</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">)])</span>
    <span class="k">assert</span> <span class="n">release</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">][</span><span class="n">exp_id</span><span class="p">][</span><span class="s1">'EXPERIMENT_TERMINATION'</span><span class="p">][</span><span class="nb">tuple</span><span class="p">([</span><span class="n">reason</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">)]</span> <span class="o">==</span> <span class="n">NUM_TERMINATIONS</span> <span class="o">*</span> <span class="n">counts</span><span class="p">,</span>\
            <span class="s1">'Expected '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">NUM_TERMINATIONS</span> <span class="o">*</span> <span class="n">counts</span><span class="p">)</span> <span class="o">+</span> \
            <span class="s1">', Got '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">release</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">][</span><span class="n">exp_id</span><span class="p">][</span><span class="s1">'EXPERIMENT_TERMINATION'</span><span class="p">][</span><span class="nb">tuple</span><span class="p">([</span><span class="n">reason</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">)])</span>

    <span class="c1">#`active` is counted for both just active, and for activations and terminations above</span>
    <span class="k">assert</span> <span class="n">release</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">][</span><span class="n">exp_id</span><span class="p">][</span><span class="s1">'active'</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span> <span class="o">==</span> <span class="n">TOTAL</span> <span class="o">*</span> <span class="n">counts</span><span class="p">,</span>\
            <span class="s1">'Expected '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">TOTAL</span> <span class="o">*</span> <span class="n">counts</span><span class="p">)</span> <span class="o">+</span>\
            <span class="s1">'Got '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">release</span><span class="p">[</span><span class="s1">'experiments'</span><span class="p">][</span><span class="n">exp_id</span><span class="p">][</span><span class="s1">'active'</span><span class="p">][</span><span class="n">branch</span><span class="p">])</span>


<span class="c1">### Test non-spark - easier debugging ###</span>

<span class="n">channel_1</span><span class="p">,</span> <span class="n">channel_2</span> <span class="o">=</span> <span class="n">get_empty_channel</span><span class="p">(),</span> <span class="n">get_empty_channel</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ping</span> <span class="ow">in</span> <span class="n">pings</span><span class="p">:</span>
    <span class="n">channel_1</span> <span class="o">=</span> <span class="n">channel_ping_agg</span><span class="p">(</span><span class="n">channel_1</span><span class="p">,</span> <span class="n">ping</span><span class="p">)</span>
    <span class="n">channel_2</span> <span class="o">=</span> <span class="n">channel_ping_agg</span><span class="p">(</span><span class="n">channel_2</span><span class="p">,</span> <span class="n">ping</span><span class="p">)</span>

<span class="c1"># no actual key-value reduce, so just have to add the channel as key</span>
<span class="n">res_chan</span> <span class="o">=</span> <span class="p">((</span><span class="n">_channel</span><span class="p">,</span> <span class="n">channel_channel_agg</span><span class="p">(</span><span class="n">channel_1</span><span class="p">,</span> <span class="n">channel_2</span><span class="p">)),)</span>
<span class="n">res_chan</span> <span class="o">=</span> <span class="n">add_counts</span><span class="p">(</span><span class="n">res_chan</span><span class="p">)</span>

<span class="c1"># we've agggregated over the pings twice, so counts=2</span>
<span class="n">channels_agg_assert</span><span class="p">({</span><span class="n">channel</span><span class="p">:</span> <span class="n">agg</span> <span class="k">for</span> <span class="n">channel</span><span class="p">,</span> <span class="n">agg</span> <span class="ow">in</span> <span class="n">res_chan</span><span class="p">},</span> <span class="n">counts</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">write_aggregate</span><span class="p">(</span><span class="n">res_chan</span><span class="p">,</span> <span class="n">the_date</span><span class="p">,</span> <span class="n">filename_prefix</span><span class="o">=</span><span class="s2">"nonspark_test"</span><span class="p">)</span>


<span class="c1">#### Test Spark ###</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">aggregate_pings</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">pings</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">add_counts</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">channels</span> <span class="o">=</span> <span class="p">{</span><span class="n">channel</span><span class="p">:</span> <span class="n">agg</span> <span class="k">for</span> <span class="n">channel</span><span class="p">,</span> <span class="n">agg</span> <span class="ow">in</span> <span class="n">res</span><span class="p">}</span>

<span class="n">channels_agg_assert</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">counts</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">write_aggregate</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">the_date</span><span class="p">,</span> <span class="n">filename_prefix</span><span class="o">=</span><span class="s2">"spark_test"</span><span class="p">)</span>
</pre></div>
<div class="codehilite"><pre><span></span>['spark_test20140101-release.json.gz']
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">### Run on actual data - use CEP to get counts ###</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">aggregate_pings</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">add_counts</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="c1">### Upload target day's data files ###</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">botocore</span>
<span class="kn">from</span> <span class="nn">boto3.s3.transfer</span> <span class="kn">import</span> <span class="n">S3Transfer</span>

<span class="n">output_files</span> <span class="o">=</span> <span class="n">write_aggregate</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">target_date</span><span class="p">)</span>

<span class="n">data_bucket</span> <span class="o">=</span> <span class="s2">"telemetry-public-analysis-2"</span>
<span class="n">s3path</span> <span class="o">=</span> <span class="s2">"experiments/data"</span>
<span class="n">gz_csv_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'ContentEncoding'</span><span class="p">:</span> <span class="s1">'gzip'</span><span class="p">,</span> <span class="s1">'ContentType'</span><span class="p">:</span> <span class="s1">'text/csv'</span><span class="p">}</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">'s3'</span><span class="p">,</span> <span class="s1">'us-west-2'</span><span class="p">)</span>
<span class="n">transfer</span> <span class="o">=</span> <span class="n">S3Transfer</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>

<span class="k">for</span> <span class="n">output_file</span> <span class="ow">in</span> <span class="n">output_files</span><span class="p">:</span>
    <span class="n">transfer</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span>
        <span class="n">output_file</span><span class="p">,</span> 
        <span class="n">data_bucket</span><span class="p">,</span> 
        <span class="s2">"{}/{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s3path</span><span class="p">,</span> <span class="n">output_file</span><span class="p">),</span>
        <span class="n">extra_args</span><span class="o">=</span><span class="n">gz_csv_args</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div></body></html>
<div>

</div>


<br/>
<div class="row">
<div class="col-md-12">
</div>
</div>




<script type="text/javascript">
            $("#searchbar")[0].setSelectionRange(1000, 1000);

            $('#searchbar').typeahead({
                hint: false,
                highlight: true,
                minLength: 1
              },
              {
                name: 'knowledge_posts',
                limit: 10,
                display: function (item) {
                  return item.title + " - " + item.author;
                },
                templates: {
                  empty: Handlebars.compile(
                    '<div class="tt-not-found">' +
                      'Unable to find any posts that match the current query' +
                      '</div>'
                  ),
                  suggestion: function(data) {
                    return '<p style="overflow-wrap:break-word"><strong class="text-rausch">' + data.title + '</strong> – ' + data.author + '</p>';
                  }
                },
                source: function(q, sync, async) {
                  $.ajax('/ajax/index/typeahead?search=' + q,
                  {
                    success: function(data,status){ async(JSON.parse(data)); }
                  })
                }
              });


            $('#searchbar').bind('typeahead:select', function(obj, datum, name) {
              window.location = '/post/'+encodeURIComponent(datum.path);
            });

            $('#searchbar').keypress(function(event){
              var keycode = (event.keyCode ? event.keyCode : event.which);
              if(keycode == '13'){
                var path = document.location.pathname;
                window.location = '/feed?filters=' + $('#searchbar').val()
              }
            });

            var padding = $('.tt-menu').outerWidth()
            $('.tt-menu').width($('#searchbar').width() + padding + "px")

        </script>
<script src="/static/legacy/knowledge-repo/js/tooltips.js" type="text/javascript"></script>
<script type="text/javascript">
$("document").ready(function(){
  var is_webeditor = false;
  
  var post_id = "15";
  var id = "None";
  var post_path = "etl/experiments.kp"
  var data_repo_github_root = ""
  tooltipsJx.initializeTooltips(is_webeditor, post_id, id, data_repo_github_root);

  $(".btn-rendered").on("click", function(){
    document.location.href = "/post/" + encodeURI(post_path);
  })

  $(".btn-raw").on("click", function(){
    document.location.href = "/post/" + encodeURI(post_path) + "?render=raw";
  })

  $(".btn-webeditor").on("click", function(){
    document.location.href = "/edit/" + encodeURI(post_path);
  })
});

</script>
<script src="/static/legacy/knowledge-repo/js/helpers.js"></script>
<script src="/static/legacy/knowledge-repo/js/tags.js" type="text/javascript"></script>
<script src="/static/legacy/knowledge-repo/js/icons.js" type="text/javascript"></script>
<script src="/static/legacy/knowledge-repo/js/comments.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js" type="text/javascript">
</script>
<script>
$(document).on('ready', function(){
  // Make the Rendered Markdown Button active
  $(".btn-rendered").addClass("btn-active");

  // Initialize headers
  helpersJx.linkifyHeaders();

  // Initialize comments
  var post_path = 'etl/experiments.kp';

  $("#post_comment_btn").on('click', function(){
      comment_author = 'knowledge_default';
      post_author = 'Frank Bertsch';
      post_title = 'Experiment Job';
      commentsJx.postComment(comment_author, post_author, post_title, post_path);
      location.reload();
  });

  all_comment_delete_buttons = $("[id^=delete_comment]")
  $.each(all_comment_delete_buttons, function(i,v){
      $(v).on("click", function(){
          var id = v.id;
          var comment_id = id.split("__")[1];
          if(comment_id) {
            commentsJx.deleteComment(post_path, comment_id)
            location.reload();
          }
      });
  });
  $(document.body).on('click',"button[id^=tag-subscription]",function () {
    tagsJx.addTagSubscriptionListener($(this)[0]);
  });
})

//Turn all the headers to be links
//h1 = Title, don't want that
var all_headers = [$("h2"), $("h3"), $("h4"), $("h5"), $("h6")]
$.each(all_headers, function(index, value){
  $.each(value, function(i, v){
    var inner_html = v.innerHTML
    inner_html_no_special = inner_html.replace(/[^a-zA-Z\- ]/g, "")
    var inner_link = "#" + inner_html_no_special.toLowerCase().split(" ").join("-")
    v.innerHTML = "<a href='" + inner_link + "' class=link-reset>" + inner_html + "</a>"
  })
})

//turn all the tags into links, similar to what's done on the feed page
var tags = $("#renderedMarkdown .metadata .tags")[0]
var tags_list = ['experiment', 'firefox']
var subscriptions_list = []
$.each(tags_list, function(i,tag){
  ahref = document.createElement("a")
  e_tag = encodeURIComponent(tag)
  f_tag = tag.replace("/", "__")
  tag_name = "#" + tag
  tag_subscription_button_id_name = "tag-subscription-" + i + "__" + f_tag
  ahref.setAttribute("data-container", "body")
  ahref.setAttribute("data-toggle", "popover")
  ahref.setAttribute("data-placement", "bottom")
  ahref.setAttribute("data-html", "true")
  ahref.setAttribute("data-tag-name", f_tag)
  if (subscriptions_list.indexOf(tag) >= 0) {
    ahref.setAttribute("class", "label label-subscribed pop")
    ahref.setAttribute("data-content", "<div class='content'>" +
                  " <button class='btn btn-small btn-primary btn-unsubscribe'" +
                        " title='' " +
                          " id='" + tag_subscription_button_id_name + "'> " +
                    " <i class='glyphicon glyphicon-remove-sign glyphicon-white'></i>Unsubscribe " +
                  " </button> " +
                  " </div>")
  } else {
    ahref.setAttribute("class", "label label-unsubscribed pop")
    ahref.setAttribute("data-content", "<div class='content'>" +
                  " <button class='btn btn-small btn-default btn-subscribe'" +
                        " title='' " +
                          " id='" + tag_subscription_button_id_name + "'> " +
                    " <i class='glyphicon glyphicon-ok-sign glyphicon-filled'></i>Subscribe " +
                  " </button> " +
                  " </div>")
  }
  ahref.setAttribute("href", "/tag_pages?tag=" + e_tag)
  ahref.setAttribute("style", "font-weight:normal")
  if (i == 0){
    ahref.innerHTML = " "
    colon = document.createElement("text")
    colon.innerHTML = "<b>Tags</b>: "
    tags.appendChild(colon)
  }
  ahref.innerHTML = ahref.innerHTML + tag_name
  tags.appendChild(ahref)
  if (i != tags_list.length - 1){
    comma = document.createElement("text")
    comma.innerText = ", "
    tags.appendChild(comma)
  }
})
tags.nextSibling.remove()

tags.innerHTML += "<i class='glyphicon glyphicon-edit icon-gray' style='font-size:12pt; padding-left:4px' id='tooltip-edit_tags'></i>"

$(".pop").popover({ trigger: "manual" , html: true, animation:false, delay: 100})
  .on("mouseenter", function () {
      var _this = this;
      $(this).popover("show");
      $(".popover").on("mouseleave", function () {
          $(_this).popover('hide');
      });
  }).on("mouseleave", function () {
      var _this = this;
      setTimeout(function () {
          if (!$(".popover:hover").length) {
              $(_this).popover("hide");
          }
      }, 300);
});

$('#tooltip-edit_tags').click(function(){
  $('#tooltip-edit_tags')[0].setAttribute("style", "display:none")
  previousSibling = $("#tooltip-edit_tags")[0].previousSibling
  tags_string = tags_list.join(", ")
  form = document.createElement("form")
  input = document.createElement("input")
  tags_text = document.createElement("text")
  icon_class = document.createElement("i")
  icon_class.setAttribute("class", "glyphicon glyphicon-upload icon-gray")
  icon_class.setAttribute("style", "font-size:23px; padding-left:4px")
  icon_class.setAttribute("id", "tooltip-save_tags")
  tags_text.innerText = "Tags: "
  input.setAttribute('type', 'text')
  input.setAttribute('name', 'tags_list')
  input.setAttribute('value', tags_string)
  input.setAttribute('style', 'width:75%; display: inline-block')
  input.setAttribute('id' , 'change_tags')
  form.appendChild(tags_text)
  tags.textContent = " "
  form.appendChild(input)
  form.appendChild(icon_class)
  tags.appendChild(form)


  $("#tooltip-save_tags").click(function(){
    tags_string = $("#change_tags")[0].value
    tags_list = tags_string.split(",")

    var re = /^[a-z0-9\-\_\:\/]+$/i
    var good = true
    for (var i = 0; i < tags_list.length; i++){
      tag = tags_list[i]
      if (tag.length == 0){
        alert("There is a tag with length 0 - possible a trailing comma?")
        good = false
        break
      } else {
        tag_name = tag.trim()
        if (!(re.test(tag_name))){
           alert("The tag contains special characters. Make sure there are only alphanumeric characters in your tag")
           good = false
           break
        }
      }
    }
    if (good) {
    var postContent = {}
      postContent['tags'] = tags_string
      $.ajax({
        type: "POST",
        dataType: "json",
        data: JSON.stringify(postContent),
        contentType: "application/json",
        url: '/tag_list?post_path=etl/experiments.kp',
        async: false
      });
      location.reload()
    }
  })

  tags.nextSibling.remove()

  // Allow user to edit tags
  var edit_icon = iconsJx.createEditTagsIcon();
  $(tags).after(edit_icon);

  $("#tooltip-edit_tags").on("click", function(){
      var edit_tooltip = $("#tooltip-edit_tags");
      edit_tooltip.attr("style", "display:none");

      var tags_string = tags_list.join(", ");
      var form = $("<form>");
      var input = $("<input>");

      var tags_text = $("<text>");
      tags_text.html("Tags: ");


      var icon = iconsJx.createSaveTagsIcon();

      input.attr("type", "text");
      input.attr("name", "tags_list");
      input.attr("style", "width:75%; display: inline-block");
      input.attr("id", "change_tags");

      form.append(tags_text);
      tags.textContent = " ";
      tags_text.innerHTML = "Tags: ";
      form.append(input);
      form.append(icon);
      tags.appendChild(form[0]);
      $("#change_tags")[0].value = tags_string;


      $("#change_tags").keypress(function(e){
          if (e.which == 13){
              var tags_string = $("#change_tags")[0].value;
              var post_path = "etl/experiments.kp";
              tagsJx.changeAndSaveTags(post_path, tags_string);
              return false;
          };
      });


      $("#tooltip-save_tags").click(function(){
          var tags_string = $("#change_tags")[0].value;
          var post_path = "etl/experiments.kp";
          tagsJx.changeAndSaveTags(post_path, tags_string);
      });

       $("form").submit(function(){
          var tags_string = $("#change_tags")[0].value;
          var post_path = "etl/experiments.kp";
          tagsJx.changeAndSaveTags(post_path, tags_string);
          return false
      })
  });

});

</script>


